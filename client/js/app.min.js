(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=function(a,b){function c(){this.constructor=a}for(var d in b)r.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},r={}.hasOwnProperty;n=function(a,b){var c,d;for(c in b)d=b[c],a[c]=d;return a},o=function(a){var b,c,d,e,f;for(a=unescape(encodeURIComponent(a)),c=a.split(""),f=[],d=0,e=c.length;e>d;d++)b=c[d],f.push(b.charCodeAt(0));return f},p=function(a){var b;return b=String.fromCharCode.apply(null,a),decodeURIComponent(escape(b))},g=function(){function a(a){this.id=a}return a.prototype.parseData=function(a){},a.prototype.getData=function(){var a,b;return a=new ArrayBuffer(1),b=new DataView(a),b.setUint8(0,this.id),a},a}(),d=function(a){function b(a){this.lobby=a,b.__super__.constructor.call(this,16)}return q(b,a),b.prototype.getData=function(){var a,b;return a=new ArrayBuffer(5),b=new DataView(a),b.setUint8(0,this.id),b.setUint32(1,this.lobby,!0),a},b}(g),j=function(a){function b(a){this.name=a,b.__super__.constructor.call(this,18)}return q(b,a),b.prototype.getData=function(){var a,b;return b=o(this.name),a=new Uint8Array(1+b.length),a.set([this.id],0),a.set(b,1),a.buffer},b}(g),l=function(a){function b(a,c){this.x=a,this.y=c,b.__super__.constructor.call(this,32)}return q(b,a),b.prototype.getData=function(){var a,b;return a=new ArrayBuffer(17),b=new DataView(a),b.setUint8(0,this.id),b.setFloat64(1,this.x,!0),b.setFloat64(9,this.y,!0),a},b}(g),h=function(a){function b(){b.__super__.constructor.call(this,36)}return q(b,a),b.prototype.parseData=function(a){var b,c;for(this.mass=a.getUint32(1,!0),this.balls=[],b=5,c=[];b<a.byteLength;)this.balls.push(a.getUint32(b,!0)),c.push(b+=4);return c},b}(g),i=function(a){function b(){b.__super__.constructor.call(this,48)}return q(b,a),b.prototype.parseData=function(a){var b,c,d,e;for(this.elements=[],c=1,e=[];c<a.byteLength;)d=f.parseElementData(a,c),c=d[0],b=d[1],e.push(this.elements.push(b));return e},b}(g),m=function(a){function b(){b.__super__.constructor.call(this,49)}return q(b,a),b.prototype.parseData=function(a){var b,c,d,e,g,h,i,j,k,l;for(this.newElements=[],this.deletedElements=[],this.updateElements=[],b=a.getUint16(1,!0),g=3,d=0,h=b;h>=0?h>d:d>h;h>=0?d++:d--)i=f.parseElementData(a,g),g=i[0],c=i[1],this.newElements.push(c);for(b=a.getUint16(g,!0),g+=2,e=0,j=b;j>=0?j>e:e>j;j>=0?e++:e--)this.deletedElements.push(a.getUint32(g,!0)),g+=4;for(l=[];g<a.byteLength;)k=f.parseElementUpdateData(a,g),g=k[0],c=k[1],l.push(this.updateElements.push(c));return l},b}(g),k=function(a){function b(){b.__super__.constructor.call(this,240)}return q(b,a),b.prototype.parseData=function(a){return this.update=a.getFloat64(1,!0),this.collision=a.getFloat64(9,!0),this.other=a.getFloat64(17,!0),this.elementCount=a.getUint32(25,!0),this.playerCount=a.getUint32(29,!0)},b}(g),e=function(a){function b(a,c){this.id=a,this.data=c,b.__super__.constructor.call(this,this.id)}return q(b,a),b.prototype.getData=function(){var a,c;return console.log("JsonData",this.id,this.data),this.data?(c=o(JSON.stringify(this.data)),a=new Uint8Array(1+c.length),a.set([this.id],0),a.set(c,1),a.buffer):b.__super__.getData.call(this)},b.prototype.parseData=function(a){var b,c,d;return c=f.parseString(a,1),b=c[0],d=c[1],this.data=JSON.parse(d)},b}(g),f=function(){function a(a){this.callbacks={},this.ws=new WebSocket(a),this.ws.binaryType="arraybuffer",this.ws.onopen=function(a){return function(){return a.onConnect?a.onConnect():void 0}}(this),this.ws.onclose=function(a){return function(){return a.onDisconnect?a.onDisconnect():void 0}}(this),this.ws.onerror=function(a){return function(a){return console.err("Error:",a)}}(this),this.ws.onmessage=function(a){return function(b){var c;return c=a.decode(b.data),a.callbacks[c.id](c)}}(this)}return a.Packets={Join:16,16:g.bind(void 0,16),Leave:17,17:g.bind(void 0,17),Start:18,18:j.bind(void 0),GetLobby:19,19:e.bind(void 0,19),UpdateTarget:32,32:l,SplitUp:33,33:g.bind(void 0,33),Shoot:34,34:g.bind(void 0,34),RIP:35,35:g.bind(void 0,35),PlayerUpdate:36,36:h,SetElements:48,48:i,UpdateElements:49,49:m,GetStats:240,240:k},a.prototype.onConnect=function(a){this.onConnect=a},a.prototype.onDisconnect=function(a){this.onDisconnect=a},a.prototype.on=function(a,b){return this.callbacks[a]=b},a.prototype.emit=function(b){return"number"==typeof b&&(b=new a.Packets[b]),this.ws.send(b.getData())},a.prototype.decode=function(b){var c,d,e;c=new DataView(b);try{return e=new(a.Packets[c.getUint8(0)]),e.parseData(c),e}catch(f){return d=f,console.error("Packet decode error",c.getUint8(0),d)}},a.parseString=function(a,b){var c,d;for(d=[];;){if(c=a.getUint8(b),b++,0===c)break;d.push(c)}return[b,p(d)]},a.parseElementData=function(b,c){var d,e,f;return f={},f.id=b.getUint32(c,!0),c+=4,f.type=b.getUint8(c),c+=1,d=a.parseString(b,c),c=d[0],f.color=d[1],e=a.parseString(b,c),c=e[0],f.name=e[1],f.x=b.getFloat64(c,!0),c+=8,f.y=b.getFloat64(c,!0),c+=8,f.size=b.getFloat64(c,!0),c+=8,[c,f]},a.parseElementUpdateData=function(a,b){var c;return c={},c.id=a.getUint32(b,!0),b+=4,c.x=a.getFloat64(b,!0),b+=8,c.y=a.getFloat64(b,!0),b+=8,c.size=a.getFloat64(b,!0),b+=8,c.velX=a.getFloat64(b,!0),b+=8,c.velY=a.getFloat64(b,!0),b+=8,[b,c]},a}(),a=function(){function a(a,b){this.options=a,n(this,b)}return a.prototype.updateData=function(a){return n(this,a)},a.prototype.update=function(a){return this.velX&&(this.x+=this.velX*a),this.velY?this.y+=this.velY*a:void 0},a.prototype.render=function(a){var b;return a.beginPath(),a.strokeStyle=this.options.borderColor,a.fillStyle=this.color||this.options.fillColor,a.lineWidth=this.options.border,a.arc(this.x,this.y,this.size,0,2*Math.PI),a.stroke(),a.fill(),this.name&&""!==this.name?(b=Math.max(this.size/2,this.options.defaultSize),a.lineWidth=this.options.textBorderSize,a.textAlign="center",a.fillStyle=this.options.textColor,a.textBaseline="middle",a.strokeStyle=this.options.textBorder,a.font="bold "+b+"px sans-serif",a.strokeText(this.name,this.x,this.y),a.fillText(this.name,this.x,this.y)):void 0},a}(),c=function(){function a(a,b){this.game=a,this.options=b}return a.prototype.render=function(a){var b,c,d,e,f,g,h,i;for(a.beginPath(),a.lineWidth=1,a.strokeStyle=this.options.lineColor,h=b=0,d=this.game.gamefield.width,e=this.options.size;e>0?d>=b:b>=d;h=b+=e)a.moveTo(h,0),a.lineTo(h,this.game.gamefield.height);for(i=c=0,f=this.game.gamefield.height,g=this.options.size;g>0?f>=c:c>=f;i=c+=g)a.moveTo(0,i),a.lineTo(this.game.gamefield.width,i);return a.stroke(),a.beginPath(),a.lineWidth=this.options.borderSize,a.strokeStyle=this.options.borderColor,a.moveTo(0,0),a.lineTo(0,this.game.gamefield.height),a.lineTo(this.game.gamefield.width,this.game.gamefield.height),a.lineTo(this.game.gamefield.width,0),a.lineTo(0,0),a.stroke()},a}(),b=function(){function b(d){this.options=n(n({},b.defaultOptions),d),this.grid=new c(this,this.options.grid),this.init(),this.net.onConnect(function(a){return function(){return console.log("Connected"),a.net.emit(f.Packets.GetLobby)}}(this)),this.net.on(f.Packets.GetLobby,function(a){return function(b){var c,d,e,f,g,h;for(a.rooms={},a.lastRoom||(a.lastRoom=b.data[b.data.length-1].id),f=b.data,d=0,e=f.length;e>d;d++)h=f[d],a.rooms[h.id]=h;console.log("Rooms:",a.rooms),a.roomsText.innerHTML="",g=a.rooms;for(c in g)h=g[c],a.roomsText.innerHTML+='<option value="'+h.id+'" '+(a.lastRoom===h.id?'selected="selected"':"")+">"+h.name+" ("+h.playerCount+")</option>";return a.join(a.lastRoom)}}(this)),this.net.on(f.Packets.Start,function(a){return function(){return console.log("Game Started"),a.gameStarted=!0}}(this)),this.net.on(f.Packets.SetElements,function(c){return function(d){var e,f,g,h,i;for(c.elements={},h=d.elements,i=[],e=0,f=h.length;f>e;e++)g=h[e],c.elements[g.id]=new a(c.options[b.ElementTypes[g.type]],g),0===g.type&&c.player.balls.hasOwnProperty(g.id)?(c.elements[g.id].options=c.options.player,i.push(c.player.balls[g.id]=c.elements[g.id])):i.push(void 0);return i}}(this)),this.net.on(f.Packets.UpdateElements,function(c){return function(d){var e,f,g,h,i,j,k,l,m,n,o,p;try{for(m=d.newElements,f=0,h=m.length;h>f;f++)l=m[f],c.elements[l.id]=new a(c.options[b.ElementTypes[l.type]],l),0===l.type&&c.player.balls.hasOwnProperty(l.id)&&(c.elements[l.id].options=c.options.player,c.player.balls[l.id]=c.elements[l.id])}catch(q){e=q}try{for(n=d.deletedElements,g=0,i=n.length;i>g;g++)l=n[g],delete c.elements[l]}catch(q){e=q}try{for(o=d.updateElements,p=[],k=0,j=o.length;j>k;k++)l=o[k],p.push(c.elements[l.id].updateData(l));return p}catch(q){e=q}}}(this)),this.net.on(f.Packets.PlayerUpdate,function(a){return function(b){var c,d,e,f;for(a.player.mass=b.mass,a.player.balls={},f=b.balls,d=0,e=f.length;e>d;d++)c=f[d],a.elements.hasOwnProperty(c)?(a.player.balls[c]=a.elements[c],a.elements[c].options=a.options.player):a.player.balls[c]=null;return a.massText.innerHTML="Mass: "+a.player.mass,a.updatePlayer()}}(this)),this.net.on(f.Packets.RIP,function(a){return function(){return console.log("You got killed"),a.gameStarted=!1,spawnbox.hidden=!1}}(this)),this.net.onDisconnect(function(a){return function(){return console.log("Disconnected"),a.inRoom=!1}}(this)),this.net.on(f.Packets.GetStats,function(a){return function(a){return console.log("Stats",a)}}(this)),this.loop()}return b.prototype.net=new f("ws://"+window.location.host+"/websocket/"),b.prototype.screen={width:window.innerWidth,height:window.innerHeight},b.prototype.view={width:window.innerWidth,height:window.innerHeight},b.prototype.gameStarted=!1,b.prototype.inRoom=!1,b.ElementTypes={0:"ball",1:"food",2:"shoot",3:"obstracle",4:"item"},b.defaultOptions={viewPortScaleFactor:.01,backgroundColor:"#EEEEEE",grid:{lineColor:"#DADADA",borderColor:"#A0A0A0",borderSize:5,size:50},food:{border:2,borderColor:"#f39c12",fillColor:"#f1c40f",size:5},obstracle:{border:5,borderColor:"#006600",fillColor:"#00FF00"},shoot:{border:2,borderColor:"#f39c12",fillColor:"#FF0000"},player:{border:5,borderColor:"#FFFFCC",fillColor:"#ea6153",textColor:"#FFFFFF",textBorder:"#000000",textBorderSize:3,defaultSize:10},ball:{border:5,borderColor:"#CC0000",fillColor:"#c0392b",textColor:"#FFFFFF",textBorder:"#000000",textBorderSize:3,defaultSize:10},item:{border:5,borderColor:"#6666FF",fillColor:"#0000FF"}},b.prototype.player={x:0,y:0,size:0,mass:0,balls:{}},b.prototype.elements={},b.prototype.target={x:0,y:0,changed:!1},b.prototype.fps=0,b.prototype.fpstimer=0,b.prototype.lastTick=0,b.prototype.name="NoName",b.prototype.rooms={},b.prototype.init=function(){return this.canvas=document.getElementById("cvs"),this.canvas.addEventListener("mousemove",function(a){return function(b){return a.target.x=b.clientX-a.screen.width/2,a.target.y=b.clientY-a.screen.height/2,a.target.changed=!0}}(this)),this.canvas.addEventListener("keypress",function(a){return function(b){return 32===b.charCode&&a.net.emit(f.Packets.SplitUp),119===b.charCode&&a.net.emit(f.Packets.Shoot),100===b.charCode?a.getStats():void 0}}(this)),this.canvas.width=this.screen.width,this.canvas.height=this.screen.height,window.addEventListener("resize",function(a){return function(){return a.screen.width=window.innerWidth,a.screen.height=window.innerHeight,a.canvas.width=window.innerWidth,a.canvas.height=window.innerHeight}}(this)),this.graph=this.canvas.getContext("2d"),this.massText=document.getElementById("mass"),this.statusText=document.getElementById("status"),this.roomsText=document.getElementById("rooms"),this.nameText=document.getElementById("name"),this.spawnbox=document.getElementById("spawnbox")},b.prototype.join=function(a){return console.log("Joining Room "+this.rooms[a].name),this.gamefield=this.rooms[a].options,this.inRoom&&a!==this.lastRoom?(this.net.emit(f.Packets.Leave),this.inRoom=!1,void setTimeout(function(b){return function(){return b.join(a)}}(this),10)):(console.log("Connecting ..."),this.net.emit(new d(a)),this.inRoom=!0,this.lastRoom=a,this.updatePlayer())},b.prototype.start=function(){return console.log("Starting Game"),this.name=this.nameText.value,this.net.emit(new j(this.name)),spawnbox.hidden=!0,this.canvas.focus()},b.prototype.loop=function(){return window.requestAnimationFrame(function(a){return function(b){var c;return c=b-a.lastTick,a.inRoom?(a.update(.001*c),a.render()):a.statusText.innerHTML="FPS: -",a.lastTick=b,a.loop()}}(this))},b.prototype.update=function(a){var b,c,d;d=this.elements;for(b in d)c=d[b],c.update(a);return this.gameStarted&&(this.updatePlayer(),this.target.changed&&(this.net.emit(new l(this.target.x,this.target.y)),this.target.changed=!1)),this.fpstimer+=a,this.fps++,this.fpstimer>=1?(this.statusText.innerHTML="FPS:"+this.fps,this.fps=0,this.fpstimer=0):void 0},b.prototype.updatePlayer=function(){var a,b,c,d;if(!this.gameStarted)return this.player.x=this.gamefield.width/2,this.player.y=this.gamefield.height/2,this.player.size=Math.log(Math.min(this.gamefield.width-this.screen.width,this.gamefield.height-this.screen.height))/this.options.viewPortScaleFactor/2;this.player.x=this.player.y=this.player.size=0,b=0,d=this.player.balls;for(c in d)a=d[c],null!==a&&(this.player.x+=a.x*a.size,this.player.y+=a.y*a.size,this.player.size+=a.size,b++);return b>0?(this.player.x/=this.player.size,this.player.y/=this.player.size,this.player.size/=b):void 0},b.prototype.render=function(){var a,b,c,d,e,f;e=1/(this.options.viewPortScaleFactor*this.player.size+1),this.graph.setTransform(e,0,0,e,this.screen.width/2-this.player.x*e,this.screen.height/2-this.player.y*e),f={left:this.player.x-this.screen.width/2/e,top:this.player.y-this.screen.height/2/e,right:this.player.x+this.screen.width/2/e,botom:this.player.y+this.screen.height/2/e},this.graph.fillStyle=this.options.backgroundColor,this.graph.fillRect(f.left,f.top,this.screen.width/e,this.screen.height/e),this.grid.render(this.graph),c=this.elements,d=[];for(a in c)b=c[a],b.x+b.size>f.left&&b.y+b.size>f.top&&b.x-b.size<f.right&&b.y-b.size<f.botom?d.push(b.render(this.graph)):d.push(void 0);return d},b.prototype.getStats=function(){this.net.emit(f.Packets.GetStats)},b.prototype.createRoom=function(a,b){this.lobbySocket.emit("createRoom",a,b)},b}(),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),this.game=new b}).call(this);